<html>
<head>
<title>js.js Complex Document Property </title>
<script type="text/javascript" src="../../src/js.O1.js"></script>
<script type="text/javascript" src="../../src/jsjs-wrapper.js"></script>
<script type="text/javascript">

  

  function start_jsjs() {
      var jsObjs = JSJS.Init();
      var map = new Array(); // Be able to map backwards from the JSObject to the real one
  
      jsjsDocument = JSJS.DefineObject(jsObjs.cx, jsObjs.glob, "document", 0, 0, 0);
      if (!jsjsDocument) {
          throw ("Creating object failed");
      } 

      // Custom Setter
      function set_customInnerHtml(cx,obj,idval,strict,str) {
        document.getElementById(map[obj]).innerHTML = str; 
      };
      
      //Wrap the setter and define the property
      var setterPtr = JSJS.wrapSetter(set_customInnerHtml);

      function customGetElement(str) {
        console.log("Calling get element for " + str + " (should see me twice)");
        if(!(document.getElementById(str).jsjs)) 
        {
          console.log("Creating the element for " + str + " (should only see me once)");
          // create the object
          var elementObject = JSJS.DefineObject(jsObjs.cx, jsjsDocument, str, 0, 0, 0);

          // create innerHTML property and assign setter 
          var ok=JSJS.DefineProperty(jsObjs.cx, elementObject, "innerHTML", 0, 0, setterPtr, 0);
          
          // map the object
          document.getElementById(str).jsjs = elementObject;
          var strptr = allocate(intArrayFromString("innerHTML"), 'i8', ALLOC_NORMAL);
          var jsval = _INT_TO_JSVAL(42);
          map[elementObject] = str; 
          //_JS_SetProperty(jsObjs.cx, elementObject, strptr, jsval);
        }

        // return object
        var retVal = document.getElementById(str).jsjs;
        return retVal;
      }

      // Wrap customGetElement
      var wrappedCustomElement = JSJS.wrapFunction({
        func: customGetElement,
        args: [JSJS.Types.charPtr],
        returns: JSJS.Types.objPtr});
      
      JSJS.DefineFunction(jsObjs.cx, jsjsDocument, "getElementById", 
          wrappedCustomElement, 1, 0);      

      
      // Everything has gone well, execute script
      var src = "document.getElementById('demo').innerHTML = 'It worked'; \
        document.getElementById('demo').innerHTML = 'The meaning of life'; \
        document.getElementById('demo2').innerHTML = 37; \
        document.getElementById('demo2').innerHTML = 42; \
        document.getElementById('demo3').innerHTML = 33.33; \
        document.getElementById('demo3').innerHTML = 33.33;";


      rval = JSJS.EvaluateScript(jsObjs.cx, jsObjs.glob, src);
      if (rval) {
          //Convert the JSVal to 'the right thing' 
          d = JSJS.identifyConvertValue(jsObjs.cx, rval);
      } else {
          d = "Can't get result because an error happened.";
      }
  
      
      // This is how you do a proper shut down
      JSJS.End(jsObjs);
  }

  </script>
</head>
<body>
    <h1>js.js Complex Document Property Test</h1>
    <p id="demo">This should be replaced by 'The meaning of life'</p>
    <p id="demo2">This should be replaced by '42'</p>
    <p id="demo3">This should be replaced by '33.33'</p>
    <script type="text/javascript"> 
      start_jsjs();
    </script>
</body>
</html>
