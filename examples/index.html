<html>

  <head>
    <script type="text/javascript" src="js.js">
    </script>
  </head>

  <body>

    <h1>My First Web Page</h1>

    <p id="demo">FAILURE.</p>

    <script type="text/javascript">
      var __stackBase__  = STACKTOP; STACKTOP += 20; assert(STACKTOP < STACK_MAX, "Ran out of stack");
      var txt = "Hello world!";
      var JSOPTION_VAROBJFIX = 1 << 2;
      var JSVERSION_LATEST = 185;

      var rt;
      var cx;
      var global;
      var sizeRuntime;
      sizeRuntime = 8*1024*1024;
      rt = _JS_Init(sizeRuntime); // JS_NewRuntime is defined to be JS_Init
      print("rt " + rt);
      // Check for null return
      cx = _JS_NewContext(rt, 8192);
      print("cx " + cx);
      // check for null return
      _JS_SetOptions(cx, JSOPTION_VAROBJFIX);
      _JS_SetVersion(cx, JSVERSION_LATEST);
      _JS_SetErrorReporter(cx, 396); // This is the default error reporter for shell/js.cpp

      // Proper way to create global object that doesn't work
      //global = _JS_NewCompartmentAndGlobalObject(cx, _global_class, 0);
      //print("global " + global);
      // check for null return

      // New attempt at handling global objects
      global = __ZL15NewGlobalObjectP9JSContext15CompartmentKind(cx, 1);
      print("global " + global);
      var ac = __stackBase__;
      __ZN22JSAutoEnterCompartmentC1Ev(ac);
      print("ac " + ac);

      __ZN22JSAutoEnterCompartment5enterEP9JSContextP8JSObject(ac, cx, global); // check return
      _JS_SetGlobalObject(cx, global);




      // Currently dying here
      //_JS_InitStandardClasses(cx,global); // check this for null return


      var filename;
      var lineno;
      var rval = __stackBase__ + 8;
      var ok;
      var source = "print(42)";
      var sourcePtr = allocate(intArrayFromString(source), 'i8', ALLOC_STACK);
      ok = _JS_EvaluateScript(cx, global, sourcePtr, source.length,
          ((__str2341155)|0), 1, rval);

      var d = __stackBase__ + 16;
      if(ok) {
        ok = _JS_ValueToNumber(cx, rval, d);
      }

      print("d " + HEAP[d]);


      _JS_DestroyContext(cx);
      //_JS_DestroyRuntime(rt); // function does not exist
      _JS_ShutDown();

      /*
      var args=new Array();
      args[0] = "-e";
      args[1] = "print(123456789)";
      args[1] = "var asdf = 7; switch(asdf) { case 1: print('one'); break; case 7: print('seven'); break; default: print('default'); break; }";
      Module.callMain(args);
      */

      document.getElementById("demo").innerHTML=_MYFUN();
    </script>

  </body>
</html>
