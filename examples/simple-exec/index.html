<html>
  <head>
    <script type="text/javascript" src="js.js"></script>
    <script type="text/javascript">


   var JSJS = {
      NewRuntime: function NewRuntime(maxbytes) {
          return _JS_Init(maxbytes);
      },
      NewContext: function NewContext(runtime, stackChunkSize) {
          return _JS_NewContext(runtime, stackChunkSize)
      },
      DestroyContext: function DestroyContext(context) {
          return _JS_DestroyContext(context);
      },
      DestroyRuntime: function DestroyRuntime(runtime) {
          return _JS_Finish(runtime);
      },
      ShutDown: function ShutDown() {
          return _JS_ShutDown();
      },
      SetOptions: function SetOptions(context, options) {
          return _JS_SetOptions(context, options);
      },
      SetVersion: function SetVersion(context, version) {
          return _JS_SetVersion(context, version);
      },
      SetErrorReporter: function SetErrorReporter(context, errorReporter) {
          var funcPosition = FUNCTION_TABLE.push(errorReporter) - 1;
          return _JS_SetErrorReporter(context, funcPosition);
      },
      NewCompartmentAndGlobalObject: function NewCompartmentAndGlobalObject(context, globalClass, principals) {
          return _JS_NewCompartmentAndGlobalObject(context, globalClass, principals);
      },
      InitStandardClasses: function InitStandardClasses(context, globalClass) {
          return _JS_InitStandardClasses(context, globalClass);
      },
      EvaluateScript: function EvaluateScript(context, global, source, filename, lineno) {
          var sourcePtr = allocate(intArrayFromString(source), 'i8', ALLOC_STACK);
          filename = allocate(intArrayFromString(filename ? filename : "undefined"), 'i8', ALLOC_STACK);
          lineno = lineno ? lineno : 0;
          var rval = allocate(8, 'i8', ALLOC_NORMAL);
          var ok = _JS_EvaluateScript(context, global, sourcePtr, source.length, filename, lineno, rval);
          if (ok == 0) {
              return null;
          }
          return rval;
      },
      ValueToNumber: function ValueToNumber(context, jsval) {
          var rval = allocate(1, 'double', ALLOC_NORMAL);
          ok = _JS_ValueToNumber(context, jsval, rval);
          if (ok == 0) {
              return null;
          }
          return getValue(rval, 'double');
      },
      DefineFunction: function DefineFunction(context, obj, name, func, nargs, flags) {
          var namePtr = allocate(intArrayFromString(name), 'i8', ALLOC_NORMAL);
          var funcPosition = FUNCTION_TABLE.push(func) - 1;
          return _JS_DefineFunction(context, obj, namePtr, funcPosition, nargs, flags);
      },
      Init: function Init() {
           // Creates a new runtime with 8MB of memory
           var rt = JSJS.NewRuntime(8*1024*1024);
           print("rt " + rt);

           var cx = JSJS.NewContext(rt, 8192);
           print("cx " + cx);

           // See documentation for explanation -- needed for most scripts
           var JSOPTION_VAROBJFIX = 1 << 2;
           JSJS.SetOptions(cx, JSOPTION_VAROBJFIX);

           // Set the version of JavaScript to 1.85
           var JSVERSION_LATEST = 185;
           JSJS.SetVersion(cx, JSVERSION_LATEST);

           // Set a function that gets called when an error happens
           function errorReporter(cx, message, report) {
               print("ERROR: " + Pointer_stringify(message));
           }
           JSJS.SetErrorReporter(cx, errorReporter);

           // This creates the "global object" in the interpreter space.
           // __global_class is defined by js/shell.cpp to be a nice, sane default
           var global = JSJS.NewCompartmentAndGlobalObject(cx, _global_class, 0);
           print("global " + global);

           // Initializes the standard javascript global objects like Array, Date, etc
           JSJS.InitStandardClasses(cx, global);

           return {rt: rt, cx: cx, glob: global};
      },
      End: function End(jsObjs) {
         JSJS.DestroyContext(jsObjs.cx);
         JSJS.DestroyRuntime(jsObjs.rt);
         JSJS.ShutDown();
      },
      Types: {
          primitive: function(type) {
              return new function() {
                  this.size = Runtime.getNativeTypeSize(type);
                  this.toPtr = function(val) {
                      var ptr = allocate(1, type, ALLOC_NORMAL);
                      setValue(ptr, val, type);
                      return ptr;
                  };
                  this.setPtr = function(val, ptr) {
                      setValue(ptr, val, type);
                  };
              }();
          },
          funcPtr: {
              size: 4,
              toPtr: function(func) {
                  var funcPosition = FUNCTION_TABLE.push(func) - 1;
                  var ptr = allocate(1, 'i32', ALLOC_NORMAL);
                  setValue(ptr, funcPosition, 'i32');
              },
              setPtr: function(val, ptr) {
                  var funcPosition = FUNCTION_TABLE.push(val) - 1;
                  setValue(ptr, funcPosition, 'i32');
              }
          },
          charPtr: {
              size: 4,
              toPtr: function(str) {
                  return allocate(intArrayFromString(str), 'i8', ALLOC_NORMAL);
              },
              setPtr: function(val, ptr) {
                  var strPtr = allocate(intArrayFromString(val), 'i8', ALLOC_NORMAL);
                  setValue(ptr, strPtr, 'i32');
              }
          },
          struct: function() {
              var typeArgs = arguments;
              return new function() {
                  this.size = 0;
                  for (i=0; i<typeArgs.length; i++) {
                      this.size += typeArgs[i].size;
                  }
                  this.toPtr = function() {
                      var valArgs = arguments;
                      var headPtr = allocate(this.size, 'i8', ALLOC_NORMAL);
                      ptr = headPtr;
                      for (i=0; i<typeArgs.length; i++) {
                          typeArgs[i].setPtr(valArgs[i], ptr);
                          ptr += typeArgs[i].size;
                      }
                      return headPtr;
                  };
              }();
          },
      },
   };
   
   JSJS.Types.i16 = JSJS.Types.primitive('i16');
   JSJS.Types.i32 = JSJS.Types.primitive('i32');
   JSJS.Types.JSFunctionSpec = JSJS.Types.struct(JSJS.Types.charPtr,
                                                 JSJS.Types.funcPtr,
                                                 JSJS.Types.i16,
                                                 JSJS.Types.i16);


function start_jsjs() {
    var src = "function x() { return Math.abs(32 * -2); } dummy(); x() + 2; ";
    var jsObjs = JSJS.Init();
    
    function dummyFunc() {
        console.log("dummy called");
        return 1;
    }
    //Define a global object called "dummy" that calls "dummyFunc"
    JSJS.DefineFunction(jsObjs.cx, jsObjs.glob, "dummy", dummyFunc, 0, 0);
    
    var rval = JSJS.EvaluateScript(jsObjs.cx, jsObjs.glob, src);
    
    var d;
    if (rval) {
        //Convert the JSVal to a double
        d = JSJS.ValueToNumber(jsObjs.cx, rval);
    } else {
        d = "Can't get result because an error happened.";
    }

    document.getElementById("demo").innerHTML = d;

    // This is how you do a proper shut down
    JSJS.End(jsObjs);
}

window.onload = start_jsjs;

    </script>
  </head>
  <body>
    <h1>js.js Simple Execution Demo</h1>
    <p id="demo">This will get replaced by the numeric result of the source being evaluted.</p>
  </body>
</html>
